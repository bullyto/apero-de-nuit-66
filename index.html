<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#0b1220" />
  <title>Calculateur TTC</title>

  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="icon-192.png" type="image/png" />
  <link rel="apple-touch-icon" href="icon-192.png" />
  <link rel="icon" href="icon-512.png" sizes="512x512" type="image/png" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* Anti-flash blanc + coh√©rence splash natif */
    html, body { background:#050914; }

    /* Petit polish marketing (sans d√©pendances) */
    .bg-neon {
      background:
        radial-gradient(900px 500px at 15% 10%, rgba(56,189,248,.22), transparent 60%),
        radial-gradient(900px 500px at 85% 15%, rgba(34,197,94,.20), transparent 55%),
        radial-gradient(900px 600px at 50% 95%, rgba(168,85,247,.14), transparent 55%),
        linear-gradient(180deg, #050914 0%, #0b1220 40%, #0b1220 100%);
    }
    .glass {
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(10px);
    }
    .ring-neon {
      box-shadow: 0 0 0 1px rgba(56,189,248,.18), 0 0 40px rgba(56,189,248,.12);
    }
    .btn {
      transition: transform .08s ease, box-shadow .12s ease, background .12s ease;
    }
    .btn:active {
      transform: translateY(1px);
    }
    @media (prefers-reduced-motion: reduce) {
      .btn { transition: none; }
    }
  </style>

  <style>
    /* UI √©pur√©e : masquage VISUEL uniquement (logique inchang√©e) */
    .bg-white\/10.px-3.py-1.text-xs.font-semibold.tracking-wide { display:none !important; }
    .mt-1.text-sm.text-white\/70 { display:none !important; }
    .glass.rounded-2xl.px-4.py-3.text-sm { display:none !important; }
    .mt-4.text-xs.text-white\/55 { display:none !important; }
    footer.mt-8 { display:none !important; }
  </style>

  <style>
    /* UI √©pur√©e : supprimer l'espace des cartes masqu√©es (stockage/astuce) */
    header .flex.flex-col.sm\:flex-row.gap-2.sm\:items-center { display:none !important; }
  </style>

</head>

<body class="min-h-screen bg-neon text-white">

  <!-- ================= SPLASH ILLUSION (centrage optique + pause 90%) ================= -->
  <div id="appSplash" style="
    position:fixed; inset:0; z-index:999999;
    display:grid; place-items:center;
    background: radial-gradient(1200px 700px at 50% 40%, #0e1d44 0%, #050914 55%, #02040a 100%);
  ">
    <div style="width:min(340px,86vw); text-align:center;">

      <!-- Wrapper centr√© + correction optique -->
      <div style="
        width:160px;height:160px;margin:0 auto;
        display:flex;align-items:center;justify-content:center;
      ">
        <img src="icon-512.png" alt="App icon"
          style="
            width:160px;height:160px;
            transform: translateX(-6px);
            border-radius:32px;
            box-shadow:0 18px 40px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.12);
            object-fit:cover;
          "
          onerror="this.onerror=null;this.src='icon-192.png';"
        />
      </div>

      <div style="
        width:160px;
        margin:14px auto 6px;
        font-size:12px;
        color:rgba(255,255,255,.75);
        text-align:right;
      ">
        <span id="spPct">0%</span>
      </div>

      <div style="
        width:160px;
        margin:0 auto;
        height:10px;
        border-radius:999px;
        overflow:hidden;
        background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
        border:1px solid rgba(255,255,255,.10);
        box-shadow: inset 0 2px 6px rgba(0,0,0,.45);
      ">
        <div id="spBar" style="
          height:100%;
          width:0%;
          border-radius:999px;
          background: linear-gradient(90deg, #38bdf8, #22d3ee);
          box-shadow:0 0 18px rgba(56,189,248,.35);
        "></div>
      </div>
    </div>
  </div>
  <!-- ================================================================================ -->

  <div class="max-w-6xl mx-auto px-4 py-6">
    <!-- Header -->
    <header class="glass ring-neon rounded-3xl px-5 py-5 md:px-7 md:py-6">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div class="flex items-center gap-4">
          <div class="shrink-0">
            <img
              src="https://static.wixstatic.com/media/bc6106_2760d0ad9fe847418ba1d73666102706~mv2.png/v1/fill/w_560,h_320,al_c,lg_1,q_85,enc_avif,quality_auto/apero%20de%20nuit%20n.png"
              alt="Ap√©ro de Nuit 66"
              class="h-14 w-auto drop-shadow"
              onerror="this.onerror=null;this.src='icon-192.png';"
            />
          </div>
          <div>
            <div class="flex items-center gap-2">
              <span class="inline-flex items-center rounded-full bg-white/10 px-3 py-1 text-xs font-semibold tracking-wide">
                Ap√©ro de Nuit 66 ‚Ä¢ PWA
              </span>
              <span class="hidden sm:inline-flex items-center rounded-full bg-emerald-400/15 px-3 py-1 text-xs font-semibold tracking-wide text-emerald-200">
                Calcul TTC + taxes
              </span>
            </div>
            <h1 class="mt-2 text-xl md:text-2xl font-extrabold leading-tight">
              Calculateur TTC
            </h1>
            <p class="mt-1 text-sm text-white/70">
              Ajoute tes produits, v√©rifie TVA + CSS, et garde tout enregistr√© <span class="font-semibold text-white/80">en local</span> jusqu‚Äô√† effacement.
            </p>
          </div>
        </div>

        <div class="flex flex-col sm:flex-row gap-2 sm:items-center">
          <div class="glass rounded-2xl px-4 py-3 text-sm">
            <div class="text-white/60">Stockage</div>
            <div class="font-semibold">LocalStorage (persistant)</div>
          </div>
          <div class="glass rounded-2xl px-4 py-3 text-sm">
            <div class="text-white/60">Astuce</div>
            <div class="font-semibold">‚ÄúEffacer tout‚Äù remet √† z√©ro</div>
          </div>
        </div>
      </div>
    </header>

    <!-- Main -->
    <main class="mt-6 grid grid-cols-1 lg:grid-cols-12 gap-6">
      <!-- Form card -->
      <section class="lg:col-span-5 glass ring-neon rounded-3xl p-5 md:p-6">
        <div class="mt-3 flex gap-2">
          <button id="modeAlcohol" type="button"
            class="px-4 py-2 rounded-2xl bg-white/15 hover:bg-white/20 border border-white/15 text-sm font-semibold">
            Alcool
          </button>
          <button id="modeSoda" type="button"
            class="px-4 py-2 rounded-2xl bg-white/5 hover:bg-white/10 border border-white/10 text-sm font-semibold text-white/80">
            Soda
          </button>
        </div>

        <div class="mt-5 grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div class="sm:col-span-2">
            <label for="name" class="block text-xs font-semibold text-white/70">Nom du produit</label>
            <input id="name" type="text"
              class="mt-1 w-full rounded-2xl bg-white/10 border border-white/10 px-4 py-3 text-white placeholder-white/40 outline-none focus:border-sky-300/50 focus:ring-2 focus:ring-sky-300/20"
              placeholder="Ex: Vodka 70 cl"
            />
          </div>

          <div>
            <label for="price" class="block text-xs font-semibold text-white/70">Prix unitaire HT (‚Ç¨)</label>
            <input id="price" type="number" step="0.01" inputmode="decimal"
              class="mt-1 w-full rounded-2xl bg-white/10 border border-white/10 px-4 py-3 text-white placeholder-white/40 outline-none focus:border-sky-300/50 focus:ring-2 focus:ring-sky-300/20"
              placeholder="Ex: 12.90"
            />
          </div>

          <div id="volumeField">
            <label for="volume" class="block text-xs font-semibold text-white/70">Volume (L)</label>
            <input id="volume" type="number" step="0.01" inputmode="decimal"
              class="mt-1 w-full rounded-2xl bg-white/10 border border-white/10 px-4 py-3 text-white placeholder-white/40 outline-none focus:border-sky-300/50 focus:ring-2 focus:ring-sky-300/20"
              placeholder="Ex: 0.70"
            />
          </div>

          <div id="degreeField">
            <label for="degree" class="block text-xs font-semibold text-white/70">Degr√© (%)</label>
            <input id="degree" type="number" step="0.1" inputmode="decimal"
              class="mt-1 w-full rounded-2xl bg-white/10 border border-white/10 px-4 py-3 text-white placeholder-white/40 outline-none focus:border-sky-300/50 focus:ring-2 focus:ring-sky-300/20"
              placeholder="Ex: 40"
            />
          </div>

          <div>
            <label for="quantity" class="block text-xs font-semibold text-white/70">Quantit√©</label>
            <input id="quantity" type="number" step="1" inputmode="numeric"
              class="mt-1 w-full rounded-2xl bg-white/10 border border-white/10 px-4 py-3 text-white placeholder-white/40 outline-none focus:border-sky-300/50 focus:ring-2 focus:ring-sky-300/20"
              placeholder="Ex: 6"
            />
          </div>
        </div>

        <div class="mt-5 flex flex-col sm:flex-row gap-3">
          <button id="addBtn"
            class="btn flex-1 rounded-2xl bg-sky-400/20 hover:bg-sky-400/30 border border-sky-300/30 px-4 py-3 font-bold">
            ‚ûï Ajouter
          </button>
          <button id="undoBtn"
            class="btn flex-1 rounded-2xl bg-white/10 hover:bg-white/15 border border-white/15 px-4 py-3 font-semibold">
            ‚Ü©Ô∏è Annuler
          </button>
          <button id="clearBtn"
            class="btn flex-1 rounded-2xl bg-rose-500/20 hover:bg-rose-500/30 border border-rose-400/30 px-4 py-3 font-semibold">
            üóëÔ∏è Effacer tout
          </button>
        </div>

        <div class="mt-4 text-xs text-white/55">
          Les donn√©es sont stock√©es <span class="font-semibold text-white/70">sur ton appareil</span> (LocalStorage). Rien n‚Äôest envoy√© sur internet.
        </div>
      </section>

      <!-- Table card -->
      <section class="lg:col-span-7 glass ring-neon rounded-3xl p-5 md:p-6">
        <div class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-3">
          <div>
            <h2 class="text-base font-bold tracking-wide text-white/90">D√©tail du calcul</h2>
            <p class="mt-1 text-sm text-white/65">TVA HT, CSS, TVA CSS et total TTC.</p>
          </div>

          <div class="glass rounded-2xl px-4 py-3">
            <div class="text-xs text-white/60">Total g√©n√©ral TTC</div>
            <div class="text-2xl font-extrabold tracking-tight">
              <span id="grand-total">0.00</span> ‚Ç¨
            </div>
          </div>
        </div>

        <div class="mt-5 overflow-x-auto rounded-2xl border border-white/10">
          <table class="min-w-full text-sm">
            <thead class="bg-white/5 text-white/80">
              <tr>
                <th class="px-4 py-3 text-left font-semibold">Produit</th>
                <th class="px-4 py-3 text-right font-semibold">Total HT</th>
                <th class="px-4 py-3 text-right font-semibold">TVA</th>
                <th class="px-4 py-3 text-right font-semibold">CSS</th>
                <th class="px-4 py-3 text-right font-semibold">TVA CSS</th>
                <th class="px-4 py-3 text-right font-semibold">Total TTC</th>
              </tr>
            </thead>
            <tbody id="product-table" class="divide-y divide-white/10 bg-black/10">
              <!-- rows injected -->
            </tbody>
          </table>
        </div>

        <div class="mt-4 text-xs text-white/55">
          üí° Conseil : si tu veux ‚Äúrepartir √† z√©ro‚Äù, utilise <span class="font-semibold text-white/75">Effacer tout</span> (√ßa supprime aussi la sauvegarde locale).
        </div>
      </section>
    </main>

    <footer class="mt-8 pb-6 text-center text-xs text-white/45">
      ¬© Ap√©ro de Nuit 66
    </footer>
  </div>

  <script>
    // === Stockage local (persistant) ‚Äî ne change PAS la logique de calcul ===
    const STORAGE_KEY = "apero_de_nuit_66_calculateur_ttc_products_v1";
    let products = [];

    // Mode de saisie : alcool (calcul complet) ou soda (TVA r√©duite, pas de CSS)
    let currentMode = "alcohol"; // "alcohol" | "soda"

    function applyMode(mode){
      currentMode = (mode === "soda") ? "soda" : "alcohol";
      const vol = document.getElementById("volumeField");
      const deg = document.getElementById("degreeField");
      const bA = document.getElementById("modeAlcohol");
      const bS = document.getElementById("modeSoda");

      // Classes (√©vite les remplacements fragiles)
      const activeCls = "px-4 py-2 rounded-2xl bg-white/15 hover:bg-white/20 border border-white/15 text-sm font-semibold";
      const inactiveCls = "px-4 py-2 rounded-2xl bg-white/5 hover:bg-white/10 border border-white/10 text-sm font-semibold text-white/80";

      if(currentMode === "soda"){
        if(vol) vol.style.display = "none";
        if(deg) deg.style.display = "none";
        if(bA) bA.className = inactiveCls;
        if(bS) bS.className = activeCls;
      } else {
        if(vol) vol.style.display = "";
        if(deg) deg.style.display = "";
        if(bA) bA.className = activeCls;
        if(bS) bS.className = inactiveCls;
      }
    }

    function saveProducts() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(products));
      } catch (e) {
        console.warn("LocalStorage indisponible :", e);
      }
    }

    function loadProducts() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) {
          const parsed = JSON.parse(raw);
          if (Array.isArray(parsed)) products = parsed;
        }
      } catch (e) {
        products = [];
      }
    }

    // Format ‚Ç¨ (FR)
    const _eur = new Intl.NumberFormat("fr-FR", { style: "currency", currency: "EUR" });
    function fmtEUR(v){
      const n = Number(v);
      return _eur.format(isFinite(n) ? n : 0);
    }

    // Rafra√Æchit le tableau + total g√©n√©ral (TTC)
    function renderTable(){
      const tbody = document.getElementById("product-table");
      const totalEl = document.getElementById("grand-total");
      if(!tbody || !totalEl) return;

      tbody.innerHTML = "";
      let grand = 0;

      for(const p of products){
        grand += Number(p.totalTTC || 0);

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="px-4 py-3 text-left text-white/90">${p.name ?? ""}</td>
          <td class="px-4 py-3 text-right">${fmtEUR(p.priceHTTotal)}</td>
          <td class="px-4 py-3 text-right">${fmtEUR(p.vatHT)}</td>
          <td class="px-4 py-3 text-right">${fmtEUR(p.cssAmount)}</td>
          <td class="px-4 py-3 text-right">${fmtEUR(p.vatCSS)}</td>
          <td class="px-4 py-3 text-right font-semibold">${fmtEUR(p.totalTTC)}</td>
        `;
        tbody.appendChild(tr);
      }

      totalEl.textContent = fmtEUR(grand);
    }

    function addProduct() {
      const name = document.getElementById("name").value?.trim();
      const price = parseFloat(document.getElementById("price").value);
      const quantity = parseInt(document.getElementById("quantity").value);

      // Champs sp√©cifiques alcool
      const volume = parseFloat(document.getElementById("volume").value);
      const degree = parseFloat(document.getElementById("degree").value);

      if (!name || isNaN(price) || isNaN(quantity)) {
        alert("Veuillez remplir le nom, le prix HT et la quantit√©.");
        return;
      }

      if (currentMode === "alcohol" && (isNaN(volume) || isNaN(degree))) {
        alert("Mode alcool : merci de renseigner aussi le volume et le degr√©.");
        return;
      }

      // --- Calcul ---
      const priceHTTotal = price * quantity;

      if (currentMode === "soda") {
        // TVA r√©duite
        const vatRate = 0.055;
        const vatHT = priceHTTotal * vatRate;
        const cssAmount = 0;
        const vatCSS = 0;
        const totalTTC = priceHTTotal + vatHT;

        products.push({ type:"soda", name, priceHTTotal, vatHT, cssAmount, vatCSS, totalTTC, vatRate });
      } else {
        // Alcool : TVA 20% + CSS + TVA sur CSS
        const vatHT = priceHTTotal * 0.20;
        const volumeAlcoolPur = volume * (degree / 100);
        const hlap = volumeAlcoolPur / 100;
        const cssAmount = hlap * 609.80 * quantity;
        const vatCSS = cssAmount * 0.20;
        const totalTTC = priceHTTotal + vatHT + cssAmount + vatCSS;

        products.push({ type:"alcohol", name, priceHTTotal, vatHT, cssAmount, vatCSS, totalTTC, vatRate:0.20 });
      }
      // -------------

      saveProducts();
      renderTable();

      // Reset inputs
      document.getElementById("name").value = "";
      document.getElementById("price").value = "";
      if (currentMode === "alcohol") {
        document.getElementById("volume").value = "";
        document.getElementById("degree").value = "";
      }
      document.getElementById("quantity").value = "";
    }

    function removeLast() {
      if (products.length === 0) return;
      products.pop();
      saveProducts();
      renderTable();
    }

    function clearAll() {
      products = [];
      try { localStorage.removeItem(STORAGE_KEY); } catch(e) {}
      renderTable();
    }

    document.getElementById("addBtn").addEventListener("click", addProduct);
    document.getElementById("undoBtn").addEventListener("click", removeLast);
    document.getElementById("clearBtn").addEventListener("click", clearAll);

    // Chargement initial depuis LocalStorage
    loadProducts();
    // Initialisation des boutons de mode
    const _bA = document.getElementById("modeAlcohol");
    const _bS = document.getElementById("modeSoda");
    if(_bA) _bA.addEventListener("click", () => applyMode("alcohol"));
    if(_bS) _bS.addEventListener("click", () => applyMode("soda"));
    applyMode("alcohol");

    renderTable();
  </script>

  <script>
    /* ===== SPLASH avec easing + pause √† 90% (effet Android) ===== */
    (function(){
      const TOTAL_MS = 1900;
      const HOLD_AT = 90;
      const HOLD_MS = 230;
      const SPLIT = 0.82;

      const splash = document.getElementById("appSplash");
      const bar = document.getElementById("spBar");
      const pct = document.getElementById("spPct");
      if(!splash || !bar || !pct) return;

      const phase1 = Math.floor(TOTAL_MS * SPLIT);
      const phase2 = TOTAL_MS - phase1 - HOLD_MS;

      let start = null;
      let holding = false;
      let holdStart = 0;

      function setP(p){
        const v = Math.max(0, Math.min(100, p));
        bar.style.width = v + "%";
        pct.textContent = Math.round(v) + "%";
      }

      function easeOutCubic(t){ return 1 - Math.pow(1 - t, 3); }

      function step(ts){
        if(!start) start = ts;
        const elapsed = ts - start;

        // Phase 1 : 0 -> 90%
        if(elapsed <= phase1){
          const t = elapsed / phase1;
          setP(easeOutCubic(t) * HOLD_AT);
          requestAnimationFrame(step);
          return;
        }

        // Hold : rester √† 90%
        if(!holding){
          holding = true;
          holdStart = ts;
          setP(HOLD_AT);
        }
        if(ts - holdStart < HOLD_MS){
          requestAnimationFrame(step);
          return;
        }

        // Phase 2 : 90 -> 100%
        const afterHold = elapsed - phase1 - HOLD_MS;
        const t2 = Math.min(1, afterHold / Math.max(1, phase2));
        const p = HOLD_AT + (100 - HOLD_AT) * easeOutCubic(t2);
        setP(p);

        if(t2 < 1){
          requestAnimationFrame(step);
        } else {
          setTimeout(() => {
            splash.style.transition = "opacity .25s ease";
            splash.style.opacity = "0";
            setTimeout(() => splash.remove(), 280);
          }, 110);
        }
      }

      setP(0);
      requestAnimationFrame(step);
    })();
  </script>

  <script>
    /* ===== Service Worker AUTO-UPDATE + RELOAD (toujours √† jour) ===== */
    (function () {
      if (!("serviceWorker" in navigator)) return;

      navigator.serviceWorker.register("./sw.js").then((reg) => {

        if (reg.waiting) {
          reg.waiting.postMessage({ type: "SKIP_WAITING" });
        }

        reg.addEventListener("updatefound", () => {
          const newWorker = reg.installing;
          if (!newWorker) return;

          newWorker.addEventListener("statechange", () => {
            if (newWorker.state === "installed" && navigator.serviceWorker.controller) {
              newWorker.postMessage({ type: "SKIP_WAITING" });
            }
          });
        });
      }).catch(()=>{});

      let reloaded = false;
      navigator.serviceWorker.addEventListener("controllerchange", () => {
        if (reloaded) return;
        reloaded = true;
        window.location.reload();
      });
    })();
  </script>

</body>
</html>
